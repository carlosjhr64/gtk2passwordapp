#!/usr/bin/env ruby
require 'rubygems'
gem 'gtk2applib', '~> 15.3'
$help = <<EOT
\t--no-gui\tcommand line access to passwords
\t--dump\t\tpp dump of data
EOT
require 'gtk2applib'
require 'gtk2passwordapp'

if (nogui = $options=~/-no-gui/) || ($options=~/-dump/) then
  $stderr.print Gtk2Password::Configuration::COMMAND_LINE_MSG1
  pwd = $stdin.gets.strip
  if nogui then
    $stderr.print Gtk2Password::Configuration::COMMAND_LINE_MSG2
    pattern = Regexp.new( $stdin.gets.strip, Regexp::IGNORECASE )
  end
  begin
    passwords = Gtk2Password::Passwords.new(Gtk2Password::Configuration::PASSWORDS_FILE, pwd)
    passwords.load
    if $options=~/-dump/ then
      require 'pp'
      pp passwords
    else
      passwords.accounts.each do |account|
        if account =~ pattern then
          password = passwords.password_of(account)
          username = passwords.username_of(account)
          puts [account,username,password].join("\n\t")
        end
      end
    end
  rescue Exception
    sleep(1.0)
    puts $!
  end
  exit
end

program = Gtk2AppLib::Program.new( Gtk2Password::ABOUT )

begin
  Gtk2Password::App.new(program)
rescue Exception
  $!.puts_bang!
ensure
  program.finalize
end

