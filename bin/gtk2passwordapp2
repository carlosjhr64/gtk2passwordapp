#!/usr/bin/env ruby
require 'rubygems'

if (nogui = ARGV.include?('--no-gui')) || (ARGV.include?('--dump')) then
  require 'gtk2passwordapp/passwords'
  # Unfortunately, gtk2applib makes this awkard.
  # Have to assume things...
  pwfile = File.expand_path('~/.gtk2passwordapp-2/passwords.dat')
  raise "Need #{pwfile}" unless File.exist?(pwfile)
  $stderr.print  "Warning: password will be shown.\nPassword:"
  pwd = $stdin.gets.strip
  if nogui then
    $stderr.print "Warning: selected passwords will be shown.\nEnter Account pattern:"
    pattern = Regexp.new( $stdin.gets.strip, Regexp::IGNORECASE )
  end
  begin
    passwords = Gtk2Password::Passwords.new(pwfile, pwd)
    passwords.load
    if $options=~/-dump/ then
      require 'pp'
      pp passwords
    else
      passwords.accounts.each do |account|
        if account =~ pattern then
          password = passwords.password_of(account)
          username = passwords.username_of(account)
          puts [account,username,password].join("\n\t")
        end
      end
    end
  rescue Exception
    puts $!
  end
  exit
end

gem 'gtk2applib', '~> 15.3'
$help = <<EOT
\t--no-gui\tcommand line access to passwords
\t--dump\t\tpp dump of data
EOT
require 'gtk2applib'
require 'gtk2passwordapp'

program = Gtk2AppLib::Program.new( Gtk2Password::ABOUT )

begin
  Gtk2Password::App.new(program)
rescue Exception
  $!.puts_bang!
ensure
  program.finalize
end

