#!/usr/bin/env ruby
module Gtk2PasswordApp
  VERSION = '6.0.210128'
  HELP = <<~HELP
    Usage:
      gtk2passwordapp [:gui+]
      gtk2passwordapp :cli <pattern>
    Gui:
      --notoggle     \tMinime wont toggle decorated and keep above
      --notdercorated\tDont decorate window
    Cli:
      --nogui
      -v --version   \tShow version and exit
      -h --help      \tShow help and exit
    # Notes #
    With the --nogui cli-option,
    one can give a pattern to filter by account names.
    Expected passwords data file is:
      ~/.cache/gtk3app/gtk2passwordapp/dump.yzb
  HELP
end

def cli(pattern)
  dump = File.expand_path('~/.cache/gtk3app/gtk2passwordapp/dump.yzb')
  unless File.exist? dump
    $stderr.puts "Passwords data file missing: #{dump}"
    exit 66
  end
  begin
    require 'yaml_zlib_blowfish'
    require 'base_convert'
  rescue LoadError
    $stderr.puts 'Missing Gem:'
    $stderr.puts $!.message
    exit 72
  end
  system('clear; clear')
  print "Enter password: "
  pwd = $stdin.gets.strip
  system('clear; clear')
  print "Enter salt: "
  pwd << $stdin.gets.strip
  system('clear; clear')
  h2q = BaseConvert::FromTo.new base: 16, digits: '0123456789ABCDEF', to_base: 91, to_digits: :qgraph
  pwd = h2q.convert Digest::SHA256.hexdigest(pwd).upcase
  begin
    lst = YamlZlibBlowfish.new(pwd).load(dump)
  rescue OpenSSL::Cipher::CipherError
    $stderr.puts "Bad password+salt"
    exit 65
  end
  pp lst.select{|k,v|pattern.match? k}
end

begin
  case ARGV
  in [/^(-v)|(--version)$/]
    puts Gtk2PasswordApp::VERSION
    exit
  in [/^(-h)|(--help)$/]
    puts Gtk2PasswordApp::HELP
    exit
  in ['--nogui', pattern]
    begin
      pattern = Regexp.new pattern, Regexp::IGNORECASE
    rescue RegexpError
      $stderr.puts $!.message
      exit 65
    end
    cli(pattern)
    exit
  else
    require 'gtk2passwordapp'
    Gkt3App.run klass:Gtk2PasswordApp
    exit
  end
end
