#!/usr/bin/env ruby
require 'rafini'
using Rafini::Exception

begin
  nogui = ARGV.include?('--no-gui')
  if nogui
    require 'user_space' # Helper Gem
    # This Gem
    require 'gtk2passwordapp/version'
    require 'gtk2passwordapp/config'

    mod     = Gtk2passwordapp
    version = mod::VERSION
    appdir  = mod::APPDIR
    config  = mod::CONFIG
    appname = File.join 'gtk3app', mod.name.downcase

    user_space = UserSpace.new(appname: appname, appdir: appdir)
    user_space.install unless user_space.version == version
    user_space.configures(config)

    pwd_file = config[:PwdFile]
    # TODO: decomment
    #raise "Could not find passwords data file." unless File.exist? pwd_file

    require 'io/console' # Standard library
    pwd0 = nil
    print 'Password: '
    pwd = $stdin.noecho(&:gets).strip
    while pwd != pwd0
      exit if pwd == ''
      puts
      print 'Again: '
      pwd0 = pwd
      pwd = $stdin.noecho(&:gets).strip
    end
    puts

    # TODO: decomment
    #accounts = Gtk2passwordapp::Accounts.new(pwd, pwd_file)

    print 'Username: '
    username = $stdin.gets.strip
    raise "Could not find account #{username}"
  end
rescue StandardError
  $!.puts
  exit 1
end
