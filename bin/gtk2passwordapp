#!/usr/bin/env ruby
require 'rubygems'
gem 'gtk2applib', '~> 3.1.0'
require 'gtk2applib/gtk2_app'

application = {
	:name		=> 'Ruby-Gnome Password Manager',
	:tooltip	=> 'Password Manager',
	:FILE		=> __FILE__,
	}
Gtk2App.init(application)
Gtk2App.icon.set_icon_name(Gtk::Stock::DIALOG_AUTHENTICATION)

menu = Gtk::Menu.new

menuitem = Gtk::MenuItem.new('Quit')
menuitem.signal_connect('activate'){
  menu.children.each{|child| child.destroy}
  menu.destroy
  Gtk2App.icon.visible = false
  Gtk.main_quit
}
menu.append(menuitem)
menu.append( Gtk::SeparatorMenuItem.new )

primary   = Gtk::Clipboard.get(Gdk::Selection::PRIMARY)
clipboard = Gtk::Clipboard.get(Gdk::Selection::CLIPBOARD)

require 'gtk2passwordapp/passwords'
passwords = Passwords.new
passwords.accounts.each {|account|
  menuitem = Gtk::MenuItem.new(account)
  menuitem.child.modify_fg(Gtk::STATE_NORMAL, RED) if passwords.expired?(account)
  menu.append(menuitem)
  menuitem.signal_connect('activate'){|b|
    primary.text = clipboard.text = passwords.password_of(b.child.text.strip)
  }
}
menu.show_all

Gtk2App.icon.signal_connect('popup-menu'){ menu.popup(nil, nil, 0, 0) }

about = {
	:authors	=> ['carlosjhr64@gmail.com'],
	:comments	=> 'Ruby-Gtk2 Passsword Manager',
	:website	=> 'http://ruby-gnome-apps.blogspot.com/search/label/Passwords',
	:website_label	=> 'Ruby-Gnome Password Manager',
	:license	=> 'GPL',
	:copyright	=> '2010-Jan-1',
	}
require 'gtk2applib/gtk2_app_widgets'
Gtk2App.main_window(about) do |window|
end
