#!/usr/bin/env ruby
require 'rubygems'
gem 'gtk2applib', '~> 13.0'
require 'gtk2applib'

include Gtk2AppLib
program = Program.new( {
	'name'		=> 'Ruby-Gnome Password Manager',
	'authors'	=> ['carlosjhr64@gmail.com'],
	'website'	=> 'http://ruby-gnome-apps.blogspot.com/search/label/Passwords',
	'website-label'	=> 'Ruby-Gnome Password Manager',
        'license'        => 'GPL',
        'copyright'      => '2010-08-17 19:00:27',
        } )

begin
  require 'gtk2passwordapp'

  passwords = Gtk2PasswordApp::Passwords.new
  Gtk2AppLib::Configuration::PARAMETERS[:Account_ComboBoxEntry][0] = passwords.accounts
  Gtk2PasswordApp.build_menu(program,passwords)

  modified = false
  program.window do |window|
    Gtk2AppLib::Dialogs::DIALOG[:Window] = window
    Gtk2AppLib::Component::Gui.new(window) do |is,signal,*emits|
      $stderr.puts "#{is},#{signal}:\t#{emits}" if $trace
      Gtk2PasswordApp.method(signal).call(is,passwords) do |action|
        case action
        when :modified then modified ||= true
        when :save
          if modified then
            Gtk2AppLib.passwords_updated( passwords.save )
            updated = false
            Gtk2PasswordApp.build_menu(passwords)
          end
          PROGRAM.close
        when :close
          if !modified || Gtk2AppLib::DIALOGS.question?(*ARE_YOU_SURE) then
            program.close
          end
        end
      end
    end
    window.signal_connect('destroy') do
      if modified then
        modified = false
        # Gtk2PasswordApp may modify passwords, but
        # unless commited to disk they're not permanent.
        passwords.load # revert
      end
    end
    window.show_all
  end
rescue Exception
  $verbose = true
  $!.puts_bang!
ensure
  program.finalize
end

