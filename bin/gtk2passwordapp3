#!/usr/bin/env ruby

if (nogui = ARGV.include?('--no-gui')) || (ARGV.include?('--dump')) then

  require 'gtk2passwordapp/passwords'
  # Unfortunately, gtk2applib makes this awkard.
  # Have to assume things...
  pwfile = File.expand_path('~/.gtk2passwordapp-3/passwords.dat')
  raise "Need #{pwfile}" unless File.exist?(pwfile)
  # Note: user may want to send stdout to a file,
  # so commicating with user via stderr.
  $stderr.print  "Warning: password will be shown.\nPassword: "
  pwd = $stdin.gets.strip

  pattern = nil
  if nogui then
    $stderr.print "Warning: selected passwords will be shown.\nEnter Account pattern: "
    pattern = Regexp.new( $stdin.gets.strip, Regexp::IGNORECASE )
  end

  begin
    passwords = Gtk2Password::Passwords.new(pwfile, pwd)
    passwords.load
    if ARGV.include?('--dump') then
      require 'pp'
      # puts to stdout
      pp passwords
    else
      passwords.accounts.each do |account|
        if account =~ pattern then
          password = passwords.password_of(account)
          username = passwords.username_of(account)
          # puts to stdout
          $stdout.puts [account,username,password].join("\n\t")
        end
      end
    end
  rescue Exception
    $stderr.puts $!
  end
  exit

end

$help = <<EOT
\t--no-gui\tcommand line access to passwords
\t--dump\t\tpp dump of data
EOT
require 'gtk2applib'
require 'gtk2passwordapp'

program = Gtk2AppLib::Program.new( Gtk2Password::ABOUT )

begin
  Gtk2Password::App.new(program)
rescue Exception
  $!.puts_bang!
ensure
  program.finalize
end
